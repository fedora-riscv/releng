#!/bin/bash

RELEASE=$1

OLDRELEASE=$(bc -l <<< "$RELEASE-1")

primary_arches="armv7hl i686 x86_64 aarch64 ppc64 ppc64le s390x"

kojicli=koji

$kojicli clone-tag --all --latest-only f$OLDRELEASE f$RELEASE
$kojicli edit-tag -x mock.package_manager=dnf f$RELEASE
$kojicli add-tag f$RELEASE-docker
$kojicli add-tag --parent f$RELEASE-docker --arches=x86_64 f$RELEASE-docker-build
$kojicli add-tag --parent f$RELEASE f$RELEASE-updates
$kojicli add-tag --parent f$RELEASE f$RELEASE-compose
$kojicli add-tag --parent f$RELEASE-updates f$RELEASE-updates-candidate
$kojicli add-tag --parent f$RELEASE-updates f$RELEASE-updates-testing
$kojicli add-tag --parent f$RELEASE-updates-testing f$RELEASE-updates-testing-pending
$kojicli add-tag --parent f$RELEASE-updates f$RELEASE-updates-pending
$kojicli add-tag --parent f$RELEASE-updates f$RELEASE-override
$kojicli add-tag --parent f$RELEASE-override --arches="\""$primary_arches"\"" f$RELEASE-build
$kojicli add-tag --parent f$RELEASE-updates-testing-pending f$RELEASE-signing-pending
$kojicli add-tag --parent f$RELEASE-updates  f$RELEASE-pending
$kojicli add-tag --parent f$RELEASE-build --arches="\""$primary_arches"\"" f$RELEASE-infra
$kojicli add-tag --parent f$RELEASE-infra --arches="\""$primary_arches"\"" f$RELEASE-infra-stg
$kojicli add-tag --parent f$RELEASE-infra-stg f$RELEASE-infra-candidate
$kojicli add-tag --parent f$RELEASE f$RELEASE-modularity
$kojicli add-tag --parent f$RELEASE f$RELEASE-openh264
$kojicli add-tag --parent f$RELEASE f$RELEASE-atomic
$kojicli edit-tag --perm=fedora-override f$RELEASE-override
$kojicli edit-tag --perm=admin f$RELEASE-updates
$kojicli edit-tag --perm=admin f$RELEASE-updates-testing
$kojicli edit-tag --perm=admin f$RELEASE-updates-testing-pending
$kojicli edit-tag --perm=admin f$RELEASE-updates-pending
$kojicli edit-tag --perm=admin f$RELEASE-atomic
$kojicli edit-tag --perm=autosign f$RELEASE-signing-pending
$kojicli edit-tag --perm=infra f$RELEASE-infra
$kojicli edit-tag --perm=autosign f$RELEASE-infra-stg
$kojicli edit-tag --perm=infra f$RELEASE-infra-candidate

$kojicli tag-pkg f$RELEASE-build $($kojicli latest-build f$OLDRELEASE-build glibc64 glibc32 --quiet|sed -e "s| .*||g" )

$kojicli add-target f$RELEASE f$RELEASE-build
$kojicli add-target f$RELEASE-candidate f$RELEASE-build f$RELEASE
$kojicli add-target f$RELEASE-infra f$RELEASE-infra f$RELEASE-infra-candidate
$kojicli add-target f$RELEASE-docker-candidate f$RELEASE-docker-build f$RELEASE-docker
$kojicli edit-target rawhide --dest-tag=f$RELEASE --build-tag=f$RELEASE-build
$kojicli edit-target rawhide-docker-candidate --dest-tag=f$RELEASE-docker --build-tag=f$RELEASE-docker-build

$kojicli remove-tag-inheritance rawhide f$OLDRELEASE
$kojicli add-tag-inheritance rawhide f$RELEASE
