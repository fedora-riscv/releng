#!/bin/bash


VERSION=$1
COMPOSE=$2
DATE=$3
DESTDIR=/srv/pungi/$VERSION$COMPOSE/
FINALDEST=/mnt/fedora_koji/compose/$VERSION$COMPOSE/
KICKSTARTS=/srv/pungi/spin-kickstarts/

FULLPATH=$(cwd)
pushd $KICKSTARTS
git pull --rebase
$FULLPATH/build-livecds $VERSION $COMPOSE
$FULLPATH/build-arm-images $VERSION $COMPOSE
$FULLPATH/build-cloud-images $VERSION $DATE
pushd

for arch in armhfp i386 x86_64
do
 if [[ $arch == armhfp ]]
  then HOST=arm03-releng00.arm.fedoraproject.org
  else HOST=compose-x86-02.phx2.fedoraproject.org
 fi

 if [[ $arch == i386 ]]
    then basearch=i686
    elif [[ $arch == armhfp ]]
    then basearch=armv7hl
    else basearch=$arch
 fi
  ssh $HOST /bin/bash -- << EOF
 set -x
 umask 002
 mock -r fedora-branched-compose-$arch --init || exit 1
 mock -r fedora-branched-compose-$arch --shell "pungi -c $KICKSTARTS/fedora-install-fedora.ks --destdir $DESTDIR --cachedir /srv/pungi/cache/ --ver $VERSION --flavor Fedora" || exit 1
 mock -r fedora-branched-compose-$arch --clean || exit 1
 sg releng "repoclosure -a $basearch --repofrompath=$arch,$DESTDIR$VERSION/Fedora/$arch/os --repoid=$arch > $DESTDIR/logs/Fedora.$arch.repoclosure.log"
 rsync -avhH --exclude=work $DESTDIR $FINALDEST
EOF

done


hardlink -vvc $FINALDEST/$VERSION/Fedora

sg releng "./build_composeinfo $FINALDEST/$VERSION/Fedora"


while true
do
  if [ $(koji list-tasks --mine|grep OPEN|grep -e livecd -e appliance|wc -l) -ne 0 ]
  then
    echo "appliance or livecd tasks running, waiting 2 minutes"
    sleep 120
  else
    break
  fi
done


pushd $FINALDEST/$VERSION/
mkdir -p Images/armhfp Images/i386 Images/x86_64 Spins/i386 Spins/x86_64 Live/i386 Live/x86_64
popd


USER=$(whoami)
SHORTCOMPOSE=$(echo $COMPOSE|sed -e 's|RC||g')
# stage images
sg releng "sudo /usr/bin/cp -l /mnt/fedora_koji/koji/scratch/$USER/task_*/Fedora*armhfp-$VERSION$SHORTCOMPOSE-sda.raw.xz $FINALDEST/$VERSION/Images/armhfp/"
sg releng "sudo /usr/bin/cp -l /mnt/fedora_koji/koji/scratch/$USER/task_*/Fedora-i386*$VERSION-$DATE-sda.raw.xz $FINALDEST/$VERSION/Images/i386/"
sg releng "sudo /usr/bin/cp -l /mnt/fedora_koji/koji/scratch/$USER/task_*/Fedora-i386*$VERSION-$DATE-sda.qcow2 $FINALDEST/$VERSION/Images/i386/"
sg releng "sudo /usr/bin/cp -l /mnt/fedora_koji/koji/scratch/$USER/task_*/Fedora-x86_64*$VERSION-$DATE-sda.raw.xz $FINALDEST/$VERSION/Images/x86_64/"
sg releng "sudo /usr/bin/cp -l /mnt/fedora_koji/koji/scratch/$USER/task_*/Fedora-x86_64*$VERSION-$DATE-sda.qcow2 $FINALDEST/$VERSION/Images/x86_64/"

sg releng "sudo /usr/bin/cp -l /mnt/fedora_koji/koji/scratch/$USER/task*/*i686*$VERSION$SHORTCOMPOSE.iso $FINALDEST/$VERSION/Spins/i386/"
sg releng "sudo /usr/bin/cp -l /mnt/fedora_koji/koji/scratch/$USER/task*/*x86_64*$VERSION$SHORTCOMPOSE.iso $FINALDEST/$VERSION/Spins/x86_64/"

mv $FINALDEST/$VERSION/Spins/i386/Fedora-Live-Desktop* $FINALDEST/$VERSION/Live/i386/
mv $FINALDEST/$VERSION/Spins/i386/Fedora-Live-KDE* $FINALDEST/$VERSION/Live/i386/
mv $FINALDEST/$VERSION/Spins/i386/Fedora-Live-XFCE* $FINALDEST/$VERSION/Live/i386/
mv $FINALDEST/$VERSION/Spins/i386/Fedora-Live-SoaS* $FINALDEST/$VERSION/Live/i386/
mv $FINALDEST/$VERSION/Spins/i386/Fedora-Live-LXDE* $FINALDEST/$VERSION/Live/i386/
mv $FINALDEST/$VERSION/Spins/i386/Fedora-Live-MATE-Compiz* $FINALDEST/$VERSION/Live/i386/
mv $FINALDEST/$VERSION/Spins/x86_64/Fedora-Live-Desktop* $FINALDEST/$VERSION/Live/x86_64/
mv $FINALDEST/$VERSION/Spins/x86_64/Fedora-Live-KDE* $FINALDEST/$VERSION/Live/x86_64/
mv $FINALDEST/$VERSION/Spins/x86_64/Fedora-Live-XFCE* $FINALDEST/$VERSION/Live/x86_64/
mv $FINALDEST/$VERSION/Spins/x86_64/Fedora-Live-SoaS* $FINALDEST/$VERSION/Live/x86_64/
mv $FINALDEST/$VERSION/Spins/x86_64/Fedora-Live-LXDE* $FINALDEST/$VERSION/Live/x86_64/
mv $FINALDEST/$VERSION/Spins/x86_64/Fedora-Live-MATE-Compiz* $FINALDEST/$VERSION/Live/x86_64/

for type in Spins Live
do
pushd $FINALDEST/$VERSION/$type/
for arch in i386 x86_64; do pushd $arch; sha256sum -b *iso>  Fedora-$type-$arch-$VERSION-CHECKSUM; popd; done
popd
done

pushd $FINALDEST/$VERSION/Images
for arch in armhfp i386 x86_64; do pushd $arch; sha256sum -b *qcow2 *raw.xz>  Fedora-Images-$arch-$VERSION-CHECKSUM; popd; done
popd

# stage the composed tree to final locateion
sg releng "mkdir /pub/alt/stage/$VERSION$COMPOSE/"
sg releng "chmod 700 /pub/alt/stage/$VERSION$COMPOSE/"
for type in Fedora Spins Live Images; do sg releng "rsync -avhH $FINALDEST/$VERSION/$type/ /pub/alt/stage/$VERSION$COMPOSE/$type/"; done
sg releng "chmod 755 /pub/alt/stage/$VERSION$COMPOSE/"

echo "======= compose output for trac ======="
echo "http://dl.fedoraproject.org/pub/alt/stage/$VERSION$COMPOSE/"
echo ""
echo "armhfp repoclosure"
echo "{{{"
cat $FINALDEST/logs/Fedora.armhfp.repoclosure.log
echo "}}}"
echo "i386 repoclosure"
echo "{{{"
cat $FINALDEST/logs/Fedora.i386.repoclosure.log
echo "}}}"
echo "x86_64 repoclosure"
echo "{{{"
cat $FINALDEST/logs/Fedora.x86_64.repoclosure.log
echo "}}}"
